<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimateChic - Complete Farm Management System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #27ae60;
            --primary-dark: #219a52;
            --secondary: #3498db;
            --accent: #9b59b6;
            --warning: #f39c12;
            --danger: #e74c3c;
            --success: #2ecc71;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray: #95a5a6;
            --border-radius: 12px;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            min-height: 600px;
        }

        /* Map Section */
        .map-section {
            position: relative;
        }

        .map-container {
            height: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 3px solid var(--white);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, #8e44ad 100%);
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            overflow-y: auto;
            max-height: 500px;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Status */
        .status {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            font-weight: 500;
        }

        .status-info {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 4px solid var(--secondary);
        }

        .status-success {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .status-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        /* Results */
        .result-card {
            background: var(--white);
            padding: 1.2rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--dark);
        }

        /* Operations */
        .operations-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .operation-card {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .operation-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        /* Progress bars */
        .progress-bar {
            background: #e0e0e0;
            border-radius: 20px;
            height: 8px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.2rem;
        }

        .status-on-track {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .status-delayed {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .status-behind {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }

        /* File Upload */
        .file-upload {
            margin: 1rem 0;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            padding: 0.8rem;
            background: var(--light);
            border: 2px dashed var(--gray);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-label:hover {
            border-color: var(--primary);
            background: rgba(39, 174, 96, 0.1);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                max-height: none;
            }
        }

        /* Leaflet Draw Controls Styling */
        .leaflet-draw-toolbar {
            margin-top: 12px;
            margin-left: 12px;
        }

        .leaflet-draw-toolbar a {
            background-color: var(--white);
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .leaflet-draw-toolbar a:hover {
            background-color: #f4f4f4;
        }
        
        /* Ensure map container has proper dimensions */
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title">🌱 ClimateChic Farm Management</h1>
            <p class="header-subtitle">Agro-Ecological Planning & Monitoring System</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Map Section -->
            <div class="map-section">
                <div class="controls">
                    <button class="btn" id="drawBtn">
                        <i class="fas fa-draw-polygon"></i> Draw Boundary
                    </button>
                    <button class="btn" id="analyzeBtn" disabled>
                        <i class="fas fa-brain"></i> Generate Plan
                    </button>
                    <button class="btn btn-warning" id="clearBtn">
                        <i class="fas fa-trash"></i> Clear Map
                    </button>
                    <button class="btn btn-secondary" id="uploadBtn">
                        <i class="fas fa-upload"></i> Upload Shapefile
                    </button>
                    <button class="btn btn-accent" id="saveBtn" disabled>
                        <i class="fas fa-download"></i> Save Boundary
                    </button>
                    <button class="btn btn-accent" id="feasibilityBtn" disabled>
                        <i class="fas fa-calculator"></i> Generate Feasibility
                    </button>
                    <button class="btn btn-accent" id="designBtn" disabled>
                        <i class="fas fa-project-diagram"></i> Generate Farm Design
                    </button>
                    <button class="btn btn-accent" id="reportBtn" disabled>
                        <i class="fas fa-file-alt"></i> Generate Comprehensive Report
                    </button>
                </div>
                
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div id="status" class="status status-info">
                    <i class="fas fa-info-circle"></i> Loading map, please wait...
                </div>

                <!-- File Upload (Hidden) -->
                <input type="file" id="shapefileInput" accept=".geojson,.json,.shp,.kml" multiple class="file-input">
                
                <!-- Operations Overview -->
                <div class="operations-grid">
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3>Operations</h3>
                        <p>Gantt Chart & Calendar</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%;"></div>
                        </div>
                        <span class="status-indicator status-on-track">On Track</span>
                    </div>
                    
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3>Accounting</h3>
                        <p>Expenses & Revenue</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 40%;"></div>
                        </div>
                        <span class="status-indicator status-behind">Needs Update</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-seedling"></i> Restoration Plan
                    </h3>
                    <div id="result-content">
                        <div class="result-card">
                            <h4 class="card-title">Farm Overview</h4>
                            <p>Draw a boundary or upload a shapefile to generate your restoration plan</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-chart-pie"></i> Quick Stats
                    </h3>
                    <div class="result-card">
                        <h4 class="card-title">Project Status</h4>
                        <p>• Trees Planted: <strong>0</strong></p>
                        <p>• Forest Cover: <strong>0%</strong></p>
                        <p>• chickens: <strong>0</strong></p>
                        <p>• Progress: <span class="status-indicator status-on-track">Not Started</span></p>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-calendar-check"></i> Recent Activities
                    </h3>
                    <div class="result-card">
                        <p><i class="fas fa-plus-circle" style="color: var(--success);"></i> System initialized</p>
                        <p><i class="fas fa-map-marker-alt" style="color: var(--secondary);"></i> Ready for mapping</p>
                        <p><i class="fas fa-clock" style="color: var(--warning);"></i> Awaiting boundary input</p>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-chart-line"></i> Feasibility Study
                    </h3>
                    <div id="feasibility-content">
                        <div class="result-card">
                            <h4 class="card-title">Feasibility Analysis</h4>
                            <p>Generate a feasibility study after creating your farm plan</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-project-diagram"></i> Farm Design
                    </h3>
                    <div id="design-content">
                        <div class="result-card">
                            <h4 class="card-title">Farm Design</h4>
                            <p>Generate a contour-based farm design after creating your farm plan</p>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-file-alt"></i> Comprehensive Report
                    </h3>
                    <div id="comprehensive-report-content">
                        <div class="result-card">
                            <h4 class="card-title">Comprehensive Report</h4>
                            <p>Generate a comprehensive report after creating your farm plan</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.3/dist/shp.js"></script>
    <script>
        // Initialize variables
        let map, drawnItems, drawControl, currentPolygon = null;
        let mapInitialized = false;
        
        // Initialize the map - ZOOMED TO LUZON, PHILIPPINES
        function initMap() {
            console.log("Initializing map...");
            
            try {
                // Check if map container exists
                if (!document.getElementById('map')) {
                    console.error("Map container not found!");
                    showError("Map container not found. Please check your HTML structure.");
                    return;
                }
                
                // Luzon, Philippines coordinates [latitude, longitude]
                const luzonCenter = [16.0, 121.0];
                
                // Create map instance
                map = L.map('map', {
                    center: luzonCenter,
                    zoom: 7
                });
                
                // Base layers
                const baseLayers = {
                    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Esri World Imagery'
                    }),
                    "Terrain": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Esri Terrain'
                    }),
                    "Dark Mode": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: 'CartoDB'
                    }),
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'OpenStreetMap'
                    })
                };
                
                // Add default base layer
                baseLayers.Satellite.addTo(map);
                
                // Add layer control
                L.control.layers(baseLayers).addTo(map);
                
                // Initialize drawn items layer
                drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);
                
                // Initialize draw control with ALL the tools
                drawControl = new L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems,
                        edit: true,
                        remove: true
                    },
                    draw: {
                        polygon: {
                            allowIntersection: false,
                            showArea: true,
                            metric: true,
                            shapeOptions: {
                                color: '#27ae60',
                                weight: 3,
                                fillOpacity: 0.3
                            }
                        },
                        rectangle: {
                            shapeOptions: {
                                color: '#27ae60',
                                weight: 3,
                                fillOpacity: 0.3
                            }
                        },
                        circle: {
                            shapeOptions: {
                                color: '#27ae60',
                                weight: 3,
                                fillOpacity: 0.3
                            }
                        },
                        marker: false,
                        polyline: false
                    }
                });
                
                map.addControl(drawControl);
                
                // Add biogeographic regions for Luzon
                addBiogeographicRegions();
                
                // Setup event listeners
                setupEventListeners();
                
                // Update status
                document.getElementById('status').textContent = "Map loaded! Click 'Draw Boundary' to start planning your farm";
                document.getElementById('status').className = 'status status-success';
                
                mapInitialized = true;
                console.log("Map initialized successfully");
                
            } catch (error) {
                console.error("Error initializing map:", error);
                showError("Error loading map: " + error.message);
            }
        }
        
        // Add biogeographic regions for Luzon, Philippines
        function addBiogeographicRegions() {
            const regions = [
                {
                    name: "Northern Luzon Highlands",
                    bounds: [[16.5, 120.5], [18.5, 121.5]],
                    color: '#27ae60'
                },
                {
                    name: "Central Luzon Plains", 
                    bounds: [[15.0, 120.5], [16.5, 121.5]],
                    color: '#f39c12'
                },
                {
                    name: "Southern Luzon Forest",
                    bounds: [[13.5, 121.0], [15.0, 122.0]],
                    color: '#3498db'
                },
                {
                    name: "Bicol Peninsula",
                    bounds: [[13.0, 123.0], [14.0, 124.0]],
                    color: '#9b59b6'
                }
            ];
            
            regions.forEach(region => {
                const rectangle = L.rectangle(region.bounds, {
                    color: region.color,
                    weight: 2,
                    fillOpacity: 0.1
                }).addTo(map);
                
                rectangle.bindPopup(`<strong>${region.name}</strong><br>Biogeographic Region of Luzon`);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Map drawing events
            map.on(L.Draw.Event.CREATED, function (e) {
                console.log("Drawing created event fired");
                const layer = e.layer;
                drawnItems.addLayer(layer);
                currentPolygon = layer;
                updateUI();
                
                // Calculate area using proper method
                const area = calculateArea(layer);
                
                layer.bindPopup(`Farm Boundary: ${area.toFixed(2)} hectares`).openPopup();
                
                document.getElementById('status').textContent = `Boundary drawn! Area: ${area.toFixed(2)} hectares. Click "Generate Plan" to analyze.`;
                document.getElementById('status').className = 'status status-success';
                
                // Update quick stats
                updateQuickStats(area);
                
                // Enable save button
                document.getElementById('saveBtn').disabled = false;
            });

            // Draw button event
            document.getElementById('drawBtn').addEventListener('click', function() {
                console.log("Draw button clicked");
                // Activate polygon drawing mode
                new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
                document.getElementById('status').textContent = 'Click on the map to start drawing your farm boundary. Double-click to finish.';
                document.getElementById('status').className = 'status status-info';
            });
            
            document.getElementById('analyzeBtn').addEventListener('click', function() {
                console.log("Analyze button clicked");
                analyzeLand();
            });
            
            document.getElementById('clearBtn').addEventListener('click', function() {
                console.log("Clear button clicked");
                clearMap();
            });
            
            // Upload shapefile button
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('shapefileInput').click();
            });
            
            // Shapefile input change
            document.getElementById('shapefileInput').addEventListener('change', function(e) {
                handleShapefileUpload(e.target.files);
            });
            
            // Save boundary button
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveBoundaryAsGeoJSON();
            });
            
            // Feasibility study button
            document.getElementById('feasibilityBtn').addEventListener('click', function() {
                console.log("Feasibility button clicked");
                generateFeasibilityStudy();
            });
            
            // Farm design button
            document.getElementById('designBtn').addEventListener('click', function() {
                console.log("Design button clicked");
                generateFarmDesign();
            });
            
            // Report button
            document.getElementById('reportBtn').addEventListener('click', function() {
                console.log("Report button clicked");
                generateComprehensiveReport();
            });
            
            // Listen for layer changes to update UI
            map.on('layeradd layerremove', updateUI);
        }
        
        // Handle shapefile upload
        function handleShapefileUpload(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                // Handle GeoJSON upload
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const geojson = JSON.parse(e.target.result);
                        loadGeoJSON(geojson);
                    } catch (error) {
                        showError("Error parsing GeoJSON file: " + error.message);
                    }
                };
                reader.readAsText(file);
            } else if (fileName.endsWith('.shp')) {
                // Handle Shapefile upload (requires shp.js)
                showError("Shapefile upload requires all component files (.shp, .shx, .dbf). Please zip them together or use GeoJSON format.");
            } else {
                showError("Unsupported file format. Please use GeoJSON or zipped Shapefile.");
            }
        }
        
        // Load GeoJSON data onto map
        function loadGeoJSON(geojson) {
            try {
                // Clear existing layers
                drawnItems.clearLayers();
                
                // Add GeoJSON to map
                const geoJsonLayer = L.geoJSON(geojson, {
                    style: {
                        color: '#27ae60',
                        weight: 3,
                        fillOpacity: 0.3
                    },
                    onEachFeature: function(feature, layer) {
                        drawnItems.addLayer(layer);
                        currentPolygon = layer;
                    }
                });
                
                // Zoom to the layer
                map.fitBounds(geoJsonLayer.getBounds());
                
                // Calculate area
                const area = calculateArea(currentPolygon);
                
                document.getElementById('status').textContent = `Shapefile loaded! Area: ${area.toFixed(2)} hectares. Click "Generate Plan" to analyze.`;
                document.getElementById('status').className = 'status status-success';
                
                // Update quick stats
                updateQuickStats(area);
                
                // Enable buttons
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('feasibilityBtn').disabled = false;
                document.getElementById('designBtn').disabled = false;
                document.getElementById('reportBtn').disabled = false;
                
            } catch (error) {
                showError("Error loading GeoJSON: " + error.message);
            }
        }
        
        // Save boundary as GeoJSON
        function saveBoundaryAsGeoJSON() {
            if (!currentPolygon) {
                showError("No boundary to save. Please draw or upload a boundary first.");
                return;
            }
            
            try {
                const geoJSON = currentPolygon.toGeoJSON();
                const geoJSONString = JSON.stringify(geoJSON, null, 2);
                const blob = new Blob([geoJSONString], { type: 'application/json' });
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'climatechic_farm_boundary.geojson';
                link.click();
                
                document.getElementById('status').textContent = "Boundary saved as GeoJSON file!";
                document.getElementById('status').className = 'status status-success';
                
            } catch (error) {
                showError("Error saving boundary: " + error.message);
            }
        }
        
        // Update UI state
        function updateUI() {
            const hasPolygon = drawnItems.getLayers().length > 0;
            document.getElementById('analyzeBtn').disabled = !hasPolygon;
            document.getElementById('saveBtn').disabled = !hasPolygon;
            document.getElementById('feasibilityBtn').disabled = !hasPolygon;
            document.getElementById('designBtn').disabled = !hasPolygon;
            document.getElementById('reportBtn').disabled = !hasPolygon;
        }
        
        // Update quick stats
        function updateQuickStats(area) {
            const statsContent = `
                <h4 class="card-title">Project Status</h4>
                <p>• Land Area: <strong>${area.toFixed(2)} hectares</strong></p>
                <p>• Estimated Trees: <strong>${Math.round(area * 100)}</strong></p>
                <p>• Estimated Chickens: <strong>${Math.round(area * 50)}</strong></p>
                <p>• Progress: <span class="status-indicator status-on-track">Ready for Analysis</span></p>
            `;
            
            document.querySelector('.sidebar-section:nth-child(2) .result-card').innerHTML = statsContent;
        }
        
        // FIXED: Proper area calculation function for geographic coordinates
        function calculateArea(layer) {
            let area = 0;
            
            if (layer instanceof L.Polygon) {
                const latLngs = layer.getLatLngs()[0];
                area = calculateGeographicArea(latLngs);
            } 
            else if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                const latLngs = [
                    bounds.getSouthWest(),
                    L.latLng(bounds.getSouthWest().lat, bounds.getNorthEast().lng),
                    bounds.getNorthEast(),
                    L.latLng(bounds.getNorthEast().lat, bounds.getSouthWest().lng)
                ];
                area = calculateGeographicArea(latLngs);
            }
            else if (layer instanceof L.Circle) {
                // For circles, use the built-in getArea method which is accurate
                area = layer.getArea();
            }
            
            return area / 10000; // Convert to hectares
        }

        // FIXED: Accurate geographic area calculation using spherical law of cosines
        function calculateGeographicArea(latLngs) {
            if (latLngs.length < 3) return 0;
            
            // Close the polygon if not already closed
            if (!latLngs[0].equals(latLngs[latLngs.length - 1])) {
                latLngs = [...latLngs, latLngs[0]];
            }
            
            let area = 0;
            const earthRadius = 6378137; // Earth's radius in meters
            const toRadians = deg => deg * (Math.PI / 180);
            
            for (let i = 0; i < latLngs.length - 1; i++) {
                const p1 = latLngs[i];
                const p2 = latLngs[i + 1];
                
                const φ1 = toRadians(p1.lat);
                const φ2 = toRadians(p2.lat);
                const Δλ = toRadians(p2.lng - p1.lng);
                
                area += Δλ * (2 + Math.sin(φ1) + Math.sin(φ2));
            }
            
            area = Math.abs(area * earthRadius * earthRadius / 2);
            return area;
        }
        
        // FIXED: Analyze land function - Now properly implemented
        function analyzeLand() {
            console.log("analyzeLand function called");
            
            const layers = drawnItems.getLayers();
            console.log("Number of layers:", layers.length);
            
            if (layers.length === 0) {
                showError("Please draw a farm boundary first!");
                return;
            }
            
            const layer = layers[0];
            
            // Calculate area properly
            const area = calculateArea(layer);
            console.log("Area calculated:", area, "hectares");
            
            // Simple region detection for Luzon
            const center = layer.getBounds().getCenter();
            let detectedRegion = "Central_Luzon_Plains"; // Default
            
            if (center.lat > 16.5) {
                detectedRegion = "Northern_Luzon_Highlands";
            } else if (center.lat < 15.0 && center.lng > 122.5) {
                detectedRegion = "Bicol_Peninsula";
            } else if (center.lat < 15.0) {
                detectedRegion = "Southern_Luzon_Forest";
            }
            
            console.log("Region detected:", detectedRegion);
            
            // Enhanced GeoAI: Soil type analysis based on region
            const soilTypes = {
                "Northern_Luzon_Highlands": "Clay Loam (Volcanic)",
                "Central_Luzon_Plains": "Silt Loam (Alluvial)", 
                "Southern_Luzon_Forest": "Sandy Clay Loam",
                "Bicol_Peninsula": "Clay (Volcanic)"
            };
            
            // Enhanced GeoAI: Slope analysis
            const slopeAnalysis = analyzeSlope(layer);
            
            // Enhanced GeoAI: Water availability
            const waterAvailability = analyzeWaterAvailability(center);
            
            // Flora database
            const FLORA_DATABASE = {
                "Northern_Luzon_Highlands": [
                    {"name": "Leucaena leucocephala", "type": "Tree", "benefit": "High-protein forage, shade"},
                    {"name": "Moringa oleifera", "type": "Tree", "benefit": "Vitamins, minerals, forage"},
                    {"name": "Morus alba (Mulberry)", "type": "Tree", "benefit": "Silkworm feed, chicken forage"},
                    {"name": "Gliricidia sepium", "type": "Tree", "benefit": "Nitrogen fixation, forage"}
                ],
                "Central_Luzon_Plains": [
                    {"name": "Acacia tortilis", "type": "Tree", "benefit": "Shade, pods for forage"},
                    {"name": "Cenchrus ciliaris", "type": "Grass", "benefit": "Drought-resistant forage"},
                    {"name": "Morus alba (Mulberry)", "type": "Tree", "benefit": "Silkworm feed, chicken forage"},
                    {"name": "Paspalum notatum", "type": "Grass", "benefit": "Ground cover, forage"}
                ],
                "Southern_Luzon_Forest": [
                    {"name": "Enterolobium cyclocarpum", "type": "Tree", "benefit": "Shade, protein-rich pods"},
                    {"name": "Morus alba (Mulberry)", "type": "Tree", "benefit": "Silkworm feed, chicken forage"},
                    {"name": "Leucaena leucocephala", "type": "Tree", "benefit": "High-protein forage, shade"},
                    {"name": "Gliricidia sepium", "type": "Tree", "benefit": "Nitrogen fixation, forage"}
                ],
                "Bicol_Peninsula": [
                    {"name": "Cocos nucifera", "type": "Tree", "benefit": "Multi-purpose, shade, forage"},
                    {"name": "Morus alba (Mulberry)", "type": "Tree", "benefit": "Silkworm feed, chicken forage"},
                    {"name": "Paspalum notatum", "type": "Grass", "benefit": "Ground cover, forage"},
                    {"name": "Acacia mangium", "type": "Tree", "benefit": "Fast-growing, soil improvement"}
                ]
            };
            
            // Generate restoration plan
            const recommendedFlora = FLORA_DATABASE[detectedRegion] || [];
            const landArea = area.toFixed(2);
            const estimatedTrees = Math.round(area * 100);
            const estimatedChickens = Math.round(area * 50);
            const bsfProduction = Math.round(area * 2);
            const silkwormProduction = Math.round(area * 5);
            
            // Pre-feasibility verification
            const isFeasible = area >= 1.0;
            const verificationStatus = isFeasible ? "PASS" : "FAIL";
            const verificationMessage = isFeasible ? 
                "Project meets minimum area requirements for feasibility" :
                "Minimum 1 hectare required for feasible operation";
            
            console.log("Plan generated:", {
                landArea,
                detectedRegion,
                floraCount: recommendedFlora.length,
                verificationStatus
            });
            
            // Display results
            displayResults({
                landArea,
                detectedRegion,
                recommendedFlora,
                estimatedTrees,
                estimatedChickens,
                bsfProduction,
                silkwormProduction,
                verificationStatus,
                verificationMessage,
                soilType: soilTypes[detectedRegion],
                slopeAnalysis,
                waterAvailability
            });
            
            // Add results to map as popup
            addMapPopup(layer, {
                landArea,
                detectedRegion,
                floraCount: recommendedFlora.length,
                verificationStatus
            });
            
            document.getElementById('status').textContent = `Analysis complete! ${landArea} hectares in ${detectedRegion.replace(/_/g, ' ')} region.`;
            document.getElementById('status').className = 'status status-success';
        }
        
        // Enhanced GeoAI: Analyze slope (simplified)
        function analyzeSlope(layer) {
            // Simplified slope analysis based on polygon complexity
            const bounds = layer.getBounds();
            const heightDiff = bounds.getNorth() - bounds.getSouth();
            
            if (heightDiff > 0.5) return "Hilly (15-30% slope) - Terracing recommended";
            if (heightDiff > 0.2) return "Rolling (5-15% slope) - Good for agroforestry";
            return "Flat (0-5% slope) - Ideal for intensive agriculture";
        }
        
        // Enhanced GeoAI: Analyze water availability
        function analyzeWaterAvailability(center) {
            // Simplified water availability based on region
            if (center.lng > 121.5) return "High (Near water sources)";
            if (center.lng > 120.5) return "Moderate (Seasonal water available)";
            return "Low (Irrigation needed)";
        }
        
        // Display results in the results panel
        function displayResults(data) {
            console.log("Displaying results:", data);
            
            let resultHTML = `
                <div class="result-card">
                    <h4 class="card-title">🌱 Restoration Plan for ${data.landArea} hectares</h4>
                    <p><strong>Region:</strong> ${data.detectedRegion.replace(/_/g, ' ')}</p>
                    <p><strong>Soil Type:</strong> ${data.soilType}</p>
                    <p><strong>Topography:</strong> ${data.slopeAnalysis}</p>
                    <p><strong>Water Availability:</strong> ${data.waterAvailability}</p>
                    
                    <div class="status ${data.verificationStatus === 'PASS' ? 'status-success' : 'status-warning'}">
                        <strong>Pre-feasibility Verification:</strong> ${data.verificationStatus}
                        <br><small>${data.verificationMessage}</small>
                    </div>
                    
                    <h5>Recommended Flora Species:</h5>
            `;
            
            data.recommendedFlora.forEach(flora => {
                resultHTML += `
                    <p>• <strong>${flora.name}</strong> (${flora.type}) - ${flora.benefit}</p>
                `;
            });
            
            resultHTML += `
                    <h5>Production Projections:</h5>
                    <p>• Trees (Year 5): <strong>${data.estimatedTrees}</strong></p>
                    <p>• Free-range Chickens (Year 2): <strong>${data.estimatedChickens}</strong></p>
                    <p>• BSF Production: <strong>${data.bsfProduction} kg/week</strong></p>
                    <p>• Silkworm Production: <strong>${data.silkwormProduction} kg/month</strong></p>
                    
                    <h5>Operational Guidelines:</h5>
                    <p>• Months 1-3: Soil preparation and pioneer species planting</p>
                    <p>• Months 4-6: Introduce nitrogen-fixing plants and cover crops</p>
                    <p>• Months 7-12: Establish poultry infrastructure and initial flock</p>
                    <p>• Free-range Chicken Raising (Broiler): 8-week cycles with mobile shelters</p>
                    <p>• Free-range Chicken Raising (Layer): Egg production with rotational grazing</p>
                    <p>• Year 2: Scale integrated systems and value-added production</p>
                    <p>• Silkworm Production: Mulberry cultivation and sericulture integration</p>
                </div>
            `;
            
            document.getElementById('result-content').innerHTML = resultHTML;
        }
        
        // Add popup to the map
        function addMapPopup(layer, data) {
            const popupContent = `
                <div style="min-width: 200px;">
                    <h4 style="color: #27ae60; margin: 0 0 10px 0;">ClimateChic Restoration Plan</h4>
                    <p><strong>Area:</strong> ${data.landArea} hectares</p>
                    <p><strong>Region:</strong> ${data.detectedRegion.replace(/_/g, ' ')}</p>
                    <p><strong>Pre-feasibility:</strong> ${data.verificationStatus}</p>
                    <p><strong>Recommended Species:</strong> ${data.floraCount}</p>
                    <p><strong>Status:</strong> Analysis Complete ✅</p>
                </div>
            `;
            
            layer.bindPopup(popupContent, {maxWidth: 300}).openPopup();
        }

        // ==================== COMPREHENSIVE FEASIBILITY STUDY ====================
        function generateFeasibilityStudy() {
            console.log("Generating feasibility study...");
            
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                showError("Please draw a farm boundary first!");
                return;
            }
            
            const layer = layers[0];
            const area = calculateArea(layer);
            const center = layer.getBounds().getCenter();
            
            // Get region for climate considerations
            let detectedRegion = "Central_Luzon_Plains";
            if (center.lat > 16.5) detectedRegion = "Northern_Luzon_Highlands";
            else if (center.lat < 15.0 && center.lng > 122.5) detectedRegion = "Bicol_Peninsula";
            else if (center.lat < 15.0) detectedRegion = "Southern_Luzon_Forest";
            
            // Calculate production capacity based on area
            const productionCapacity = calculateProductionCapacity(area);
            
            // Generate comprehensive feasibility study
            const feasibilityData = {
                farmArea: area,
                region: detectedRegion,
                productionCapacity: productionCapacity,
                broilerStudy: generateBroilerFeasibility(area, detectedRegion),
                layerStudy: generateLayerFeasibility(area, detectedRegion),
                financialAnalysis: generateFinancialAnalysis(area),
                riskAssessment: generateRiskAssessment(detectedRegion),
                implementationTimeline: generateImplementationTimeline()
            };
            
            // Display feasibility results
            displayFeasibilityResults(feasibilityData);
            
            document.getElementById('status').textContent = "Feasibility study generated successfully!";
            document.getElementById('status').className = 'status status-success';
        }

        function calculateProductionCapacity(area) {
            return {
                broilerCapacity: Math.floor(area * 500), // 500 birds per hectare
                layerCapacity: Math.floor(area * 300),   // 300 layers per hectare
                growingArea: area * 0.7,                 // 70% for production
                bufferZone: area * 0.3                   // 30% for buffers and infrastructure
            };
        }

        function generateBroilerFeasibility(area, region) {
            const capacity = Math.floor(area * 500);
            const cyclesPerYear = region.includes('Highlands') ? 5 : 6; // Fewer cycles in cooler highlands
            
            return {
                productionSystem: "Free-Range with Mobile Shelters",
                stockDensity: "500 birds per hectare",
                productionCycles: `${cyclesPerYear} cycles per year`,
                batchSize: capacity,
                annualProduction: capacity * cyclesPerYear,
                growingPeriod: "8 weeks per cycle",
                feedRequirements: {
                    starter: `${Math.round(capacity * 1.2)} kg/cycle`,
                    grower: `${Math.round(capacity * 3.5)} kg/cycle`,
                    totalAnnual: `${Math.round(capacity * 4.7 * cyclesPerYear / 1000)} tons/year`
                },
                infrastructure: [
                    "Mobile shelters (1 per 100 birds)",
                    "Portable water systems",
                    "Electric fencing for rotation",
                    "Feed storage facilities"
                ],
                laborRequirements: {
                    daily: "2-3 hours per 100 birds",
                    weekly: "15-20 hours total",
                    specialTasks: "Rotation every 3-4 days"
                }
            };
        }

        function generateLayerFeasibility(area, region) {
            const capacity = Math.floor(area * 300);
            const productionPeriod = 72; // weeks (18 months)
            const peakProduction = region.includes('Highlands') ? 85 : 90; // % peak production
            
            return {
                productionSystem: "Free-Range with Fixed Housing + Rotational Grazing",
                stockDensity: "300 layers per hectare",
                productionPeriod: `${productionPeriod} weeks (18 months)`,
                flockSize: capacity,
                annualEggProduction: Math.round(capacity * peakProduction / 100 * 365 * 0.9),
                expectedProduction: {
                    peak: `${peakProduction}% production`,
                    average: "280-300 eggs per hen annually",
                    total: `${Math.round(capacity * 290)} eggs per year`
                },
                feedRequirements: {
                    daily: `${Math.round(capacity * 0.12)} kg/day`,
                    monthly: `${Math.round(capacity * 0.12 * 30 / 1000)} tons/month`,
                    annual: `${Math.round(capacity * 0.12 * 365 / 1000)} tons/year`
                },
                infrastructure: [
                    "Weather-proof laying houses",
                    "Nesting boxes (1 per 4 hens)",
                    "Automatic waterers",
                    "Feed storage systems",
                    "Egg collection and storage"
                ],
                laborRequirements: {
                    daily: "3-4 hours for flock of 300",
                    weekly: "20-25 hours total",
                    specialTasks: "Egg collection twice daily, health checks"
                }
            };
        }

        function generateFinancialAnalysis(area) {
            const broilerCapacity = Math.floor(area * 500);
            const layerCapacity = Math.floor(area * 300);
            
            return {
                capitalInvestment: {
                    broilers: {
                        infrastructure: Math.round(broilerCapacity * 150),
                        equipment: Math.round(broilerCapacity * 75),
                        initialStock: Math.round(broilerCapacity * 2.5),
                        total: Math.round(broilerCapacity * 227.5)
                    },
                    layers: {
                        infrastructure: Math.round(layerCapacity * 300),
                        equipment: Math.round(layerCapacity * 120),
                        initialStock: Math.round(layerCapacity * 4.0),
                        total: Math.round(layerCapacity * 424)
                    },
                    totalInitialInvestment: Math.round(broilerCapacity * 227.5 + layerCapacity * 424)
                },
                operationalCosts: {
                    broilers: {
                        feedPerCycle: Math.round(broilerCapacity * 4.7 * 45), // 45 PHP/kg feed
                        utilities: Math.round(broilerCapacity * 5),
                        labor: Math.round(broilerCapacity * 3),
                        veterinary: Math.round(broilerCapacity * 2),
                        totalPerCycle: Math.round(broilerCapacity * 55.7)
                    },
                    layers: {
                        feedMonthly: Math.round(layerCapacity * 0.12 * 30 * 45), // 45 PHP/kg feed
                        utilities: Math.round(layerCapacity * 3),
                        labor: Math.round(layerCapacity * 4),
                        veterinary: Math.round(layerCapacity * 1.5),
                        totalMonthly: Math.round(layerCapacity * 0.12 * 30 * 45 + 8.5)
                    }
                },
                revenueProjection: {
                    broilers: {
                        pricePerKg: 180, // PHP
                        averageWeight: 1.8, // kg
                        revenuePerCycle: Math.round(broilerCapacity * 1.8 * 180 * 0.9), // 90% survival
                        annualRevenue: Math.round(broilerCapacity * 1.8 * 180 * 0.9 * 5.5)
                    },
                    layers: {
                        pricePerEgg: 8, // PHP
                        monthlyRevenue: Math.round(layerCapacity * 0.9 * 25 * 8), // 25 eggs/month, 90% production
                        annualRevenue: Math.round(layerCapacity * 0.9 * 25 * 8 * 12)
                    },
                    totalAnnualRevenue: Math.round(
                        (broilerCapacity * 1.8 * 180 * 0.9 * 5.5) + 
                        (layerCapacity * 0.9 * 25 * 8 * 12)
                    )
                },
                profitability: {
                    paybackPeriod: "18-24 months",
                    annualNetProfit: "25-35% of revenue",
                    breakEven: "12-15 months",
                    roi: "30-40% annually"
                }
            };
        }

        function generateRiskAssessment(region) {
            const risks = {
                common: [
                    "Disease outbreaks (Newcastle, AI)",
                    "Predator attacks",
                    "Feed price fluctuations",
                    "Market price volatility"
                ],
                regional: region.includes('Highlands') ? [
                    "Colder temperatures affecting production",
                    "Limited market access",
                    "Higher transportation costs"
                ] : [
                    "Heat stress during summer months",
                    "Higher disease pressure",
                    "Competition in local markets"
                ],
                mitigation: [
                    "Biosecurity protocols implementation",
                    "Vaccination programs",
                    "Diversified marketing channels",
                    "Feed storage and price hedging",
                    "Insurance coverage for livestock"
                ]
            };
            
            return risks;
        }

        function generateImplementationTimeline() {
            return [
                { phase: "Months 1-2", activities: ["Infrastructure development", "Equipment procurement", "Staff training"] },
                { phase: "Months 3-4", activities: ["First broiler batch", "Layer pullet acquisition", "System testing"] },
                { phase: "Months 5-8", activities: ["Full production scaling", "Market development", "Process optimization"] },
                { phase: "Months 9-12", activities: ["Expansion planning", "Value-added products", "Brand development"] }
            ];
        }

        function displayFeasibilityResults(data) {
            const feasibilityHTML = `
                <div class="result-card">
                    <h4 class="card-title">📊 Comprehensive Feasibility Study</h4>
                    <p><strong>Farm Area:</strong> ${data.farmArea.toFixed(2)} hectares</p>
                    <p><strong>Region:</strong> ${data.region.replace(/_/g, ' ')}</p>
                    
                    <h5>🏗 Production Capacity</h5>
                    <p>• Broiler Capacity: <strong>${data.productionCapacity.broilerCapacity} birds</strong></p>
                    <p>• Layer Capacity: <strong>${data.productionCapacity.layerCapacity} hens</strong></p>
                    <p>• Production Area: <strong>${data.productionCapacity.growingArea.toFixed(2)} ha</strong></p>
                    <p>• Buffer Zone: <strong>${data.productionCapacity.bufferZone.toFixed(2)} ha</strong></p>
                    
                    <h5>🐔 Free-Range Broiler Production</h5>
                    <p>• System: ${data.broilerStudy.productionSystem}</p>
                    <p>• Annual Production: <strong>${data.broilerStudy.annualProduction.toLocaleString()} birds</strong></p>
                    <p>• Feed Required: ${data.broilerStudy.feedRequirements.totalAnnual}</p>
                    
                    <h5>🥚 Free-Range Layer Production</h5>
                    <p>• System: ${data.layerStudy.productionSystem}</p>
                    <p>• Annual Egg Production: <strong>${data.layerStudy.annualEggProduction.toLocaleString()} eggs</strong></p>
                    <p>• Feed Required: ${data.layerStudy.feedRequirements.annual}</p>
                    
                    <h5>💰 Financial Analysis</h5>
                    <p>• Total Investment: <strong>₱${data.financialAnalysis.capitalInvestment.totalInitialInvestment.toLocaleString()}</strong></p>
                    <p>• Annual Revenue: <strong>₱${data.financialAnalysis.revenueProjection.totalAnnualRevenue.toLocaleString()}</strong></p>
                    <p>• Payback Period: ${data.financialAnalysis.profitability.paybackPeriod}</p>
                    <p>• ROI: ${data.financialAnalysis.profitability.roi}</p>
                    
                    <h5>⚠️ Risk Assessment</h5>
                    <p><strong>Main Risks:</strong></p>
                    <ul>
                        ${data.riskAssessment.common.map(risk => `<li>${risk}</li>`).join('')}
                        ${data.riskAssessment.regional.map(risk => `<li>${risk}</li>`).join('')}
                    </ul>
                    
                    <p><strong>Risk Mitigation:</strong></p>
                    <ul>
                        ${data.riskAssessment.mitigation.map(mitigation => `<li>${mitigation}</li>`).join('')}
                    </ul>
                    
                    <h5>📅 Implementation Timeline</h5>
                    ${data.implementationTimeline.map(phase => `
                        <p><strong>${phase.phase}:</strong> ${phase.activities.join(', ')}</p>
                    `).join('')}
                    
                    <div class="status status-success">
                        <strong>Feasibility Conclusion:</strong> VIABLE PROJECT<br>
                        <small>Recommended for implementation with proper risk management</small>
                    </div>
                </div>
            `;
            
            document.getElementById('feasibility-content').innerHTML = feasibilityHTML;
        }

        // ==================== FARM DESIGN GENERATION ====================
        function generateFarmDesign() {
            console.log("Generating farm design...");
            
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                showError("Please draw a farm boundary first!");
                return;
            }
            
            const layer = layers[0];
            const area = calculateArea(layer);
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            
            // Get region for design considerations
            let detectedRegion = "Central_Luzon_Plains";
            if (center.lat > 16.5) detectedRegion = "Northern_Luzon_Highlands";
            else if (center.lat < 15.0 && center.lng > 122.5) detectedRegion = "Bicol_Peninsula";
            else if (center.lat < 15.0) detectedRegion = "Southern_Luzon_Forest";
            
            // Clear existing design if any
            clearExistingDesign();
            
            // Generate contour-based strip design
            const farmDesign = createContourStripDesign(bounds, area, detectedRegion);
            
            // Display design information
            displayFarmDesign(farmDesign);
            
            document.getElementById('status').textContent = "Farm design generated successfully! Contour strips created with integrated chicken rotation system.";
            document.getElementById('status').className = 'status status-success';
        }

        function clearExistingDesign() {
            // Remove any existing design elements (keep only the original boundary)
            drawnItems.eachLayer(function(layer) {
                if (layer instanceof L.Polygon && layer !== currentPolygon) {
                    drawnItems.removeLayer(layer);
                }
            });
        }

        function createContourStripDesign(bounds, area, region) {
            const center = bounds.getCenter();
            const width = bounds.getEast() - bounds.getWest();
            const height = bounds.getNorth() - bounds.getSouth();
            
            // Create 12 strips (5 flora strips + 7 fallow strips for chickens)
            const totalStrips = 12;
            const stripWidth = width / totalStrips;
            
            const designData = {
                totalStrips: totalStrips,
                floraStrips: 5,
                chickenStrips: 7,
                stripWidth: stripWidth,
                strips: []
            };
            
            // Generate contour strips (alternating elevation simulation)
            for (let i = 0; i < totalStrips; i++) {
                const stripBounds = [
                    [bounds.getSouth(), bounds.getWest() + i * stripWidth],
                    [bounds.getNorth(), bounds.getWest() + (i + 1) * stripWidth]
                ];
                
                // Simulate elevation based on position (higher in the middle)
                const elevation = 50 + Math.abs(i - totalStrips/2) * 20; // meters
                const isChickenStrip = i % 2 === 0; // Even strips for chickens
                
                const strip = {
                    id: i + 1,
                    type: isChickenStrip ? 'chicken' : 'flora',
                    elevation: Math.round(elevation),
                    bounds: stripBounds,
                    floraType: isChickenStrip ? null : determineFloraForStrip(region, elevation, i),
                    chickenSchedule: isChickenStrip ? getChickenSchedule(i) : null
                };
                
                // Create visual representation
                createStripPolygon(strip);
                designData.strips.push(strip);
            }
            
            return designData;
        }

        function determineFloraForStrip(region, elevation, stripIndex) {
            // Base flora based on region
            const regionalFlora = {
                "Northern_Luzon_Highlands": [
                    {name: "Leucaena leucocephala", purpose: "Nitrogen fixation, forage"},
                    {name: "Morus alba (Mulberry)", purpose: "Silkworm feed, chicken forage"},
                    {name: "Gliricidia sepium", purpose: "Green manure, living fence"},
                    {name: "Moringa oleifera", purpose: "High-nutrient forage"},
                    {name: "Acacia mangium", purpose: "Windbreak, soil improvement"}
                ],
                "Central_Luzon_Plains": [
                    {name: "Cenchrus ciliaris", purpose: "Drought-resistant forage"},
                    {name: "Paspalum notatum", purpose: "Ground cover, erosion control"},
                    {name: "Morus alba (Mulberry)", purpose: "Silkworm production"},
                    {name: "Leucaena leucocephala", purpose: "Protein-rich forage"},
                    {name: "Azolla pinnata", purpose: "Water conservation, bio-fertilizer"}
                ],
                "Southern_Luzon_Forest": [
                    {name: "Enterolobium cyclocarpum", purpose: "Shade, protein pods"},
                    {name: "Gliricidia sepium", purpose: "Biomass production"},
                    {name: "Morus alba (Mulberry)", purpose: "Integrated sericulture"},
                    {name: "Pennisetum purpureum", purpose: "High-yield fodder"},
                    {name: "Desmanthus virgatus", purpose: "Adaptive legume forage"}
                ],
                "Bicol_Peninsula": [
                    {name: "Cocos nucifera", purpose: "Multi-purpose agroforestry"},
                    {name: "Morus alba (Mulberry)", purpose: "Silkworm integration"},
                    {name: "Leucaena diversifolia", purpose: "Acid-tolerant forage"},
                    {name: "Setaria sphacelata", purpose: "High-altitude grass"},
                    {name: "Calliandra calothyrsus", purpose: "Bee forage, soil conservation"}
                ]
            };
            
            // Adjust based on elevation
            let floraIndex = stripIndex % 5;
            if (elevation > 100) {
                // Higher elevation adaptations
                floraIndex = (floraIndex + 2) % 5;
            } else if (elevation < 30) {
                // Lower elevation adaptations
                floraIndex = (floraIndex + 1) % 5;
            }
            
            return regionalFlora[region][floraIndex];
        }

        function getChickenSchedule(stripIndex) {
            // 7 chicken strips for 7 days (Monday to Sunday)
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayIndex = stripIndex % 7;
            
            return {
                day: days[dayIndex],
                rotation: dayIndex < 5 ? 'Broiler Rotation' : 'Layer Free-Range', // Weekdays vs weekends
                activities: dayIndex < 5 ? 
                    ['Morning release', 'Supplemental feeding', 'Evening shelter'] : 
                    ['Free-ranging', 'Natural foraging', 'Health inspection']
            };
        }

        function createStripPolygon(strip) {
            const color = strip.type === 'chicken' ? '#FF6B6B' : '#4ECDC4';
            const opacity = strip.type === 'chicken' ? 0.4 : 0.6;
            
            const polygon = L.rectangle(strip.bounds, {
                color: color,
                weight: 2,
                fillColor: color,
                fillOpacity: opacity
            });
            
            // Add popup with strip information
            const popupContent = strip.type === 'chicken' ? 
                `<strong>Chicken Strip ${strip.id}</strong><br>
                 Day: ${strip.chickenSchedule.day}<br>
                 Type: ${strip.chickenSchedule.rotation}<br>
                 Elevation: ${strip.elevation}m<br>
                 Activities: ${strip.chickenSchedule.activities.join(', ')}` :
                `<strong>Flora Strip ${strip.id}</strong><br>
                 Plant: ${strip.floraType.name}<br>
                 Purpose: ${strip.floraType.purpose}<br>
                 Elevation: ${strip.elevation}m<br>
                 Region: Adaptive species`;
            
            polygon.bindPopup(popupContent);
            drawnItems.addLayer(polygon);
        }

        function displayFarmDesign(designData) {
            const designHTML = `
                <div class="result-card">
                    <h4 class="card-title">🌿 Contour Farm Design</h4>
                    <p><strong>Total Strips:</strong> ${designData.totalStrips} strips</p>
                    <p><strong>Flora Strips:</strong> ${designData.floraStrips} strips</p>
                    <p><strong>Chicken Strips:</strong> ${designData.chickenStrips} strips</p>
                    <p><strong>Strip Width:</strong> ${(designData.stripWidth * 111320).toFixed(0)} meters</p>
                    
                    <h5>🔄 Chicken Rotation System</h5>
                    <p>• <strong>Monday-Friday:</strong> Broiler rotation strips</p>
                    <p>• <strong>Saturday-Sunday:</strong> Layer free-range strips</p>
                    <p>• <strong>Daily rotation:</strong> Prevents overgrazing</p>
                    <p>• <strong>Natural fertilization:</strong> Chicken manure enrichment</p>
                    
                    <h5>🌱 Contour Strip Benefits</h5>
                    <p>• <strong>Erosion control:</strong> Follows natural contours</p>
                    <p>• <strong>Water conservation:</strong> Captures rainfall</p>
                    <p>• <strong>Biodiversity:</strong> Multiple species integration</p>
                    <p>• <strong>Pest management:</strong> Natural barriers</p>
                    
                    <h5>📅 Weekly Schedule</h5>
                    ${designData.strips.filter(s => s.type === 'chicken').map(strip => `
                        <p>• <strong>${strip.chickenSchedule.day}:</strong> Strip ${strip.id} - ${strip.chickenSchedule.rotation}</p>
                    `).join('')}
                    
                    <div class="status status-success">
                        <strong>Design Complete:</strong> OPTIMAL LAYOUT<br>
                        <small>Contour strips with integrated chicken rotation system</small>
                    </div>
                </div>
            `;
            
            document.getElementById('design-content').innerHTML = designHTML;
        }
        
        // ==================== COMPREHENSIVE REPORT GENERATION ====================
        function generateComprehensiveReport() {
            console.log("Generating comprehensive report...");
            
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                showError("Please draw a farm boundary first!");
                return;
            }
            
            const layer = layers[0];
            const area = calculateArea(layer);
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            
            // Get region for the report
            let detectedRegion = "Central_Luzon_Plains";
            if (center.lat > 16.5) detectedRegion = "Northern_Luzon_Highlands";
            else if (center.lat < 15.0 && center.lng > 122.5) detectedRegion = "Bicol_Peninsula";
            else if (center.lat < 15.0) detectedRegion = "Southern_Luzon_Forest";
            
            // Generate all necessary data
            const productionCapacity = calculateProductionCapacity(area);
            const broilerStudy = generateBroilerFeasibility(area, detectedRegion);
            const layerStudy = generateLayerFeasibility(area, detectedRegion);
            const financialAnalysis = generateFinancialAnalysis(area);
            const riskAssessment = generateRiskAssessment(detectedRegion);
            const designData = createContourStripDesign(bounds, area, detectedRegion);
            
            // Generate comprehensive report
            const report = createComprehensiveReport({
                farmArea: area,
                region: detectedRegion,
                center: center,
                productionCapacity: productionCapacity,
                broilerStudy: broilerStudy,
                layerStudy: layerStudy,
                financialAnalysis: financialAnalysis,
                riskAssessment: riskAssessment,
                designData: designData
            });
            
            // Display the report
            displayComprehensiveReport(report);
            
            document.getElementById('status').textContent = "Comprehensive report generated successfully!";
            document.getElementById('status').className = 'status status-success';
        }

        function createComprehensiveReport(data) {
            const currentDate = new Date().toLocaleDateString('en-PH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            return {
                title: `ClimateChic Comprehensive Farm Report - ${currentDate}`,
                sections: {
                    executiveSummary: generateExecutiveSummary(data),
                    biophysicalAnalysis: generateBiophysicalAnalysis(data),
                    feasibilityStudy: generateFeasibilityStudy(data),
                    farmDesign: generateFarmDesignReport(data),
                    operationalManual: generateOperationalManual(data),
                    businessPlan: generateBusinessPlan(data),
                    recommendations: generateRecommendations(data)
                }
            };
        }

        function generateExecutiveSummary(data) {
            return `This comprehensive report presents a complete analysis for a ${data.farmArea.toFixed(2)}-hectare integrated agro-ecological farm located in the ${data.region.replace(/_/g, ' ')} region of Luzon, Philippines. The project demonstrates strong economic viability with an estimated annual revenue potential of ₱${data.financialAnalysis.revenueProjection.totalAnnualRevenue.toLocaleString()} and a projected ROI of ${data.financialAnalysis.profitability.roi}. The integrated design combines free-range poultry production with sustainable agroforestry, creating a resilient farming system that maximizes land productivity while promoting environmental sustainability.`;
        }

        function generateBiophysicalAnalysis(data) {
            return `The farm is situated in the ${data.region.replace(/_/g, ' ')} biogeographic region, characterized by unique soil and climatic conditions ideal for integrated farming systems. Based on the geographic analysis, the area exhibits favorable conditions for both agricultural and livestock production. The terrain analysis suggests optimal conditions for contour-based farming practices, which will help prevent soil erosion and maximize water retention. The region's climate supports year-round production with appropriate management practices. Water availability appears sufficient for the proposed operations, though rainwater harvesting and conservation measures are recommended for drought resilience.`;
        }

        function generateFeasibilityStudy(data) {
            return `The economic feasibility analysis indicates a highly viable project with a total investment requirement of approximately ₱${data.financialAnalysis.capitalInvestment.totalInitialInvestment.toLocaleString()}. The integrated operation will support ${data.productionCapacity.broilerCapacity.toLocaleString()} free-range broilers with ${data.broilerStudy.annualProduction.toLocaleString()} birds produced annually across ${data.broilerStudy.productionCycles}, alongside ${data.productionCapacity.layerCapacity.toLocaleString()} laying hens producing approximately ${data.layerStudy.annualEggProduction.toLocaleString()} eggs annually. The projected payback period is ${data.financialAnalysis.profitability.paybackPeriod} with break-even achieved within ${data.financialAnalysis.profitability.breakEven}. Key risk factors include ${data.riskAssessment.common.slice(0, 2).join(' and ')}, which can be mitigated through ${data.riskAssessment.mitigation.slice(0, 2).join(' and ')}.`;
        }

        function generateFarmDesignReport(data) {
            return `The farm design employs an innovative contour-based strip system dividing the ${data.farmArea.toFixed(2)}-hectare property into ${data.designData.totalStrips} productive strips. This includes ${data.designData.floraStrips} flora strips dedicated to multi-purpose agroforestry species and ${data.designData.chickenStrips} chicken rotation strips supporting a daily movement system. The design follows natural elevation contours, optimizing water management and minimizing erosion. Each flora strip is planted with regionally appropriate species selected for their complementary functions including nitrogen fixation, forage production, soil improvement, and biodiversity enhancement. The chicken rotation system ensures optimal pasture management while providing natural fertilization across the entire farm.`;
        }

        function generateOperationalManual(data) {
            return `OPERATIONAL PROTOCOLS

Broiler Management: Birds will be rotated daily through designated strips using mobile shelters. Each batch undergoes an 8-week cycle with specific feeding protocols: starter ration (1.2kg/bird) for weeks 1-3, grower ration (3.5kg/bird) for weeks 4-8. Daily monitoring includes health checks, water quality assurance, and predator protection.

Layer Management: Hens will free-range during daylight hours with access to weather-proof laying houses containing nesting boxes (1:4 ratio). Eggs will be collected twice daily at 10:00 AM and 4:00 PM. Flocks will be replaced every 18 months to maintain optimal production.

Flora Management: The agroforestry system requires seasonal maintenance including pruning, mulching, and intercropping. Nitrogen-fixing species will be managed through coppicing to provide continuous green manure and forage resources.

Integrated Systems: Chicken manure will be directly utilized through rotational grazing, eliminating external fertilizer requirements. Black soldier fly production will convert farm waste into high-protein feed, creating a closed-loop system.`;
        }

        function generateBusinessPlan(data) {
            return `BUSINESS STRATEGY

Market Approach: Products will be marketed through multiple channels including local markets, direct consumer sales, and potential restaurant partnerships. The free-range, ecological production method commands premium pricing of ₱180/kg for broilers and ₱8/egg for layers.

Financial Projections: Year 1 revenue is projected at ₱${data.financialAnalysis.revenueProjection.totalAnnualRevenue.toLocaleString()} with 25-35% net profit margin. Operational costs are estimated at ₱${(data.financialAnalysis.operationalCosts.broilers.totalPerCycle * 5.5 + data.financialAnalysis.operationalCosts.layers.totalMonthly * 12).toLocaleString()} annually, primarily consisting of feed (65%), labor (20%), and utilities (15%).

Growth Strategy: Phase 1 (Months 1-6) establishes core operations. Phase 2 (Months 7-12) expands value-added products including processed chicken and egg products. Phase 3 (Year 2) explores market expansion and potential franchise opportunities.

Sustainability Goals: The operation aims to achieve 90% feed self-sufficiency through integrated forage systems, 100% waste recycling through composting and insect production, and carbon-positive operations through perennial agroforestry components.`;
        }

        function generateRecommendations(data) {
            return `KEY RECOMMENDATIONS

1. Immediate Implementation: Begin with infrastructure development and initial plantings in Month 1, followed by first broiler batch in Month 3 and layer pullet acquisition in Month 4.

2. Monitoring Framework: Establish weekly performance metrics including feed conversion ratios, egg production rates, forage availability, and soil health indicators.

3. Risk Management: Implement biosecurity protocols immediately, establish relationships with backup feed suppliers, and develop emergency response plans for extreme weather events.

4. Community Engagement: Explore partnership opportunities with local farmers for knowledge sharing and potential cooperative marketing initiatives.

5. Continuous Improvement: Schedule quarterly system reviews to optimize operations based on performance data and emerging best practices in sustainable agriculture.`;
        }

        function displayComprehensiveReport(report) {
            const reportHTML = `
                <div class="result-card">
                    <h4 class="card-title">📋 ${report.title}</h4>
                    
                    <h5>📄 Executive Summary</h5>
                    <p>${report.sections.executiveSummary}</p>
                    
                    <h5>🌿 Biophysical Analysis</h5>
                    <p>${report.sections.biophysicalAnalysis}</p>
                    
                    <h5>💰 Feasibility Study</h5>
                    <p>${report.sections.feasibilityStudy}</p>
                    
                    <h5>🎨 Farm Design Overview</h5>
                    <p>${report.sections.farmDesign}</p>
                    
                    <h5>⚙️ Operational Manual</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${report.sections.operationalManual}</pre>
                    </div>
                    
                    <h5>📈 Business Plan</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${report.sections.businessPlan}</pre>
                    </div>
                    
                    <h5>🎯 Recommendations</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${report.sections.recommendations}</pre>
                    </div>
                    
                    <div class="status status-success">
                        <strong>Report Complete:</strong> READY FOR IMPLEMENTATION<br>
                        <small>Comprehensive planning document generated on ${new Date().toLocaleDateString()}</small>
                    </div>
                </div>
            `;
            
            document.getElementById('comprehensive-report-content').innerHTML = reportHTML;
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('status').textContent = message;
            document.getElementById('status').className = 'status status-warning';
        }
        
        // Clear map function
        function clearMap() {
            drawnItems.clearLayers();
            currentPolygon = null;
            updateUI();
            document.getElementById('status').textContent = "Map cleared. Click 'Draw Boundary' to start drawing.";
            document.getElementById('status').className = 'status status-info';
            
            // Reset quick stats
            document.querySelector('.sidebar-section:nth-child(2) .result-card').innerHTML = `
                <h4 class="card-title">Project Status</h4>
                <p>• Trees Planted: <strong>0</strong></p>
                <p>• Forest Cover: <strong>0%</strong></p>
                <p>• Chickens: <strong>0</strong></p>
                <p>• Progress: <span class="status-indicator status-on-track">Not Started</span></p>
            `;
        
            // Reset results
            document.getElementById('result-content').innerHTML = `
                <div class="result-card">
                    <h4 class="card-title">Farm Overview</h4>
                    <p>Draw a boundary to generate your personalized restoration plan</p>
                </div>
            `;
            
            // Reset feasibility
            document.getElementById('feasibility-content').innerHTML = `
                <div class="result-card">
                    <h4 class="card-title">Feasibility Analysis</h4>
                    <p>Generate a feasibility study after creating your farm plan</p>
                </div>
            `;
            
            // Reset design
            document.getElementById('design-content').innerHTML = `
                <div class="result-card">
                    <h4 class="card-title">Farm Design</h4>
                    <p>Generate a contour-based farm design after creating your farm plan</p>
                </div>
            `;
            
            // Reset report
            document.getElementById('comprehensive-report-content').innerHTML = `
                <div class="result-card">
                    <h4 class="card-title">Comprehensive Report</h4>
                    <p>Generate a comprehensive report after creating your farm plan</p>
                </div>
            `;
            
            // Reset file input
            document.getElementById('shapefileInput').value = '';
        }
        
        // Initialize the map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                showError("Leaflet library failed to load. Please check your internet connection.");
                return;
            }
            
            // Initialize the map
            initMap();
        });
    </script>
</body>
</html>